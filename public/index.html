<html>
    <head>
        <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css"
        />
        <style>
            .Details {
                background-color: #eee;
                padding-left: 20px;
            }
            .TootMeta {
                background-color: black;
                color: white;
            }
            .TootText {
                font-family: monospace;
                color:blueviolet;
            }
            .TootBody {
                font-family: monospace;
                padding-left: 30px; 
            }
            .Metadata {
                font-family: monospace;
            }
        </style>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
        <title>Mastodon Bot</title>
    </head>
    <body>
        <main class="container">
            <h1>Mastodon Bot v 1.0.1</h1>

            <p>Monitoring @hochstenbach@mathstodon.xyz</p>

            <h2>Details</h2>

            <p class="Details"></p>

            <h2>Inbox</h2>

            <p>[<a href="inbox/">Show</a>]</p>

            <i>Contents</i>
            <ul class="List"> 
            </ul>

            <!-- jQuery Script -->
            <script>
                $(document).ready(function() {
                    setTimeout(updateList, 2000);
                });

                function updateList() {
                    $.getJSON("inbox/", (data) => {
                        const members = data['contains'].sort(
                            function(a,b){ return b.localeCompare(a); }
                        );

                        $('.List').empty();

                        for (let i = 0 ; i < members.length ; i++) {
                            const member = members[i];
                            $('.List').append(`<li><a href="${member}" class="toot">${member}</a></li>`); 
                        }

                        $("a.toot").click(async function(e) {
                            e.preventDefault();
                            const href = $(this).attr('href');
                            const toot = await $.getJSON(href);
                            const content = toot['object']['content'].replace(/(<([^>]+)>)/ig, '');
                            const published = toot['published'];
                            const attributedTo = toot['actor']['id'];
                            const urls = toot['object']['url'];

                            const references = urls.map( (re) => {
                                return `<li><a href=\"${re.href}" class=\"reference">${re.href}</a></li>`;
                            }).join("\n");

                            let metadata = '<ul>';
                            for (let i = 0; i < urls.length ; i++) {
                                const met = await getMetdata(urls[i]['href']);
                                metadata += `<li class="Metadata">${JSON.stringify(met)}</li>`;
                            }

                            $(".Details").html(`
<div class="TootMeta"><tt>${published} - ${attributedTo}</tt></div>
<div class="TootText">&gt;&gt;{text}</div>
<div class="TootBody">${content}</div>
<div class="TootText">&gt;&gt;{references}<ul>${references}</ul></div>
<div class="TootText">&gt;&gt;{zotero}</div>
${metadata}
                            `);
                            return false;
                        });
                    }).fail(function(){
                        console.log("Failed to retrieve /inbox/");
                    });
                    setTimeout(updateList, 2000);
                }

                async function getMetdata(url) {
                    return new Promise( (resolve) => {
                        $.ajax({
                            url:         "/service/z/web",
                            type:        "POST",
                            data:        url,
                            contentType: "text/plain",
                            dataType:    "json",
                            success:     function(result) {
                                resolve(result);
                            },
                            error: function() {
                                resolve({'error':'no zotero server available'});
                            }
                        });
                    });
                }
            </script>
        </main>
    </body>
</html>